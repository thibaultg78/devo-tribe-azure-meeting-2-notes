<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pr√©sence √âquipe</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: rgba(247, 247, 247, 1);
            min-height: 100vh;
            padding: 15px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
            padding: 25px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            font-weight: 700;
        }

        .user-info {
            font-size: 0.9rem;
            opacity: 0.9;
            color: white;
        }

        .controls {
            padding: 15px 20px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .btn {
            background: rgba(255, 82, 82, 1);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        h1 {
            color: white;
        }

        .btn:hover {
            background: rgba(255, 82, 82, 1);
            transform: translateY(-1px);
        }

        .table-container {
            overflow-x: auto;
            max-height: 80vh;
            overflow-y: auto;
        }

        .compact-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .compact-table th,
        .compact-table td {
            border: 1px solid #e5e7eb;
            padding: 8px 10px;
            text-align: center;
        }

        .compact-table th {
            background: rgba(255, 82, 82, 1);
            font-weight: 600;
            color: #374151;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .compact-table th:first-child {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white !important;
            text-align: left;
            min-width: 180px;
            max-width: 180px;
            position: sticky;
            left: 0;
            z-index: 20;
        }

        .compact-table td:first-child {
            text-align: left;
            font-weight: 600;
            background: #fafbfc;
            position: sticky;
            left: 0;
            z-index: 5;
            border-right: 2px solid #e5e7eb;
        }

        .collab-name {
            font-size: 12px;
            color: #1f2937;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 170px;
        }

        .collab-name.current-user {
            color: #4f46e5;
            font-weight: 700;
        }

        .compact-table .week-separator {
            border-left: 3px solid #878787 !important;
        }

        .current-user-row td {
            background-color: #fff8b3 !important;
        }

        .presence-select {
            width: 90px;
            height: 32px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 4px 6px;
            font-size: 11px;
            font-weight: 600;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            appearance: none;
            text-align: center;
            text-align-last: center;
        }

        .presence-select:hover {
            border-color: #4f46e5;
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.15);
        }

        .presence-select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
        }

        .presence-select.devoteam {
            background-color: #d1fae5;
            border-color: #10b981;
            color: #065f46;
        }

        .presence-select.client {
            background-color: #fef3c7;
            border-color: #f59e0b;
            color: #92400e;
        }

        .presence-select.remote {
            background-color: #dbeafe;
            border-color: #3b82f6;
            color: #1e40af;
        }

        .presence-select.off {
            background-color: #fee2e2;
            border-color: #ef4444;
            color: #991b1b;
        }

        .presence-select.undefined {
            background-color: #f9fafb;
            border-color: #9ca3af;
            color: #6b7280;
        }

        .presence-select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #f3f4f6;
        }

        .date-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 85px;
            color: white;
        }

        .date-number {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 1px;
        }

        .date-day {
            font-size: 0.7rem;
            opacity: 0.8;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .error {
            background: #fee2e2;
            color: #dc2626;
            padding: 12px;
            border-radius: 6px;
            margin: 15px;
            border-left: 4px solid #dc2626;
            font-size: 14px;
        }

        .stats {
            display: flex;
            gap: 20px;
            justify-content: center;
            padding: 15px 20px;
            background: #f8fafc;
            font-size: 10px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 1.0rem;
            font-weight: 700;
            color: #e53e3e;
        }

        .stat-label {
            color: #6b7280;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .container {
                margin: 5px;
                border-radius: 8px;
            }

            .compact-table {
                font-size: 12px;
            }

            .compact-table th,
            .compact-table td {
                padding: 6px 8px;
            }

            .presence-select {
                width: 70px;
                height: 28px;
                font-size: 10px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 10px;">
                <img src="https://creativetech-fr.devoteam.com/wp-content/uploads/2021/11/cropped-favicon_dvt_ct.png"
                    alt="Devoteam" style="height: 60px;">
                <div style="flex: 1; text-align: center;">
                    <h1>Tribe Azure ‚òÅÔ∏è - Together ü§©</h1>
                </div>
            </div>
            <div class="user-info" id="userInfo">Chargement...</div>
        </div>

        <div class="controls">
            <button class="btn" onclick="refreshData()">üîÑ Actualiser</button>
            <button class="btn" onclick="showLunchPopup()" style="margin-left: 10px;">üçΩÔ∏è D√©jeuner ?</button>
            <div id="topStats"></div>
        </div>

        <div id="loading" class="loading">
            ‚è≥ Chargement des collaborateurs de la Tribe Azure...
        </div>

        <div id="mainContent" style="display: none;">
            <div class="table-container">
                <table class="compact-table">
                    <thead>
                        <tr id="headerRow">
                            <th>Collaborateur</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="stats">
            <div style="text-align: center; width: 100%; color: #6b7280; font-weight: 500;">Contact : <a
                    href="mailto:thibault.gibard@devoteam.com">thibault.gibard@devoteam.com</a> üìß
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let collaborateurs = [];
        let presences = {};
        let dates = [];

        // Generate array of 10 working days (excluding weekends)
        function generateDates() {
            const dateList = [];
            const today = new Date();
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - 1);
            let currentDate = new Date(startDate);
            let daysAdded = 0;

            while (daysAdded < 10) {
                if (currentDate.getDay() !== 0 && currentDate.getDay() !== 6) {
                    dateList.push(new Date(currentDate));
                    daysAdded++;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return dateList;
        }

        // Format date for display
        function formatDate(date) {
            const days = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
            return {
                number: date.getDate(),
                day: days[date.getDay()],
                key: date.toISOString().split('T')[0]
            };
        }

        // Display error message
        function showError(message) {
            const errorDiv = document.getElementById('errorDiv');
            errorDiv.innerHTML = `<div class="error">‚ö†Ô∏è ${message}</div>`;
            errorDiv.style.display = 'block';
        }

        // Initial data loading
        function loadData() {
            dates = generateDates();
            google.script.run
                .withSuccessHandler(handleUserData)
                .withFailureHandler(handleError)
                .getCurrentUser();
        }

        // Handle user data response
        function handleUserData(userData) {
            currentUser = userData;
            document.getElementById('userInfo').textContent = `Chargement des donn√©es pour ${userData.email}... üîÑ`;
            google.script.run
                .withSuccessHandler(handleCollaborateurs)
                .withFailureHandler(handleError)
                .getCollaborateurs();
        }

        // Handle collaborators list response
        function handleCollaborateurs(data) {
            collaborateurs = data || [];
            const isInDatabase = collaborateurs.some(c => c.email.toLowerCase() === currentUser.email.toLowerCase());

            if (isInDatabase) {
                document.getElementById('userInfo').textContent = `Collaborateur d√©tect√© : ${currentUser.email} ‚úÖ ${currentUser.isManager ? '(Vue Manager) üö®' : ''}`;
            } else {
                document.getElementById('userInfo').textContent = `Collaborateur d√©tect√© : ${currentUser.email} (utilisateur absent de la BDD - acc√®s en lecture seule üò≠) ${currentUser.isManager ? '(Manager)' : ''}`;
            }

            google.script.run
                .withSuccessHandler(handlePresences)
                .withFailureHandler(handleError)
                .getPresencesForDates(dates.map(d => d.toISOString().split('T')[0]));
        }

        // Handle presences data response
        function handlePresences(data) {
            presences = data || {};
            document.getElementById('topStats').innerHTML = createStatsHTML();
            renderTable();
            document.getElementById('loading').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }

        // Handle errors
        function handleError(error) {
            showError(error.message || error.toString());
            document.getElementById('loading').style.display = 'none';
        }

        // Render the main presence table
        function renderTable() {
            const headerRow = document.getElementById('headerRow');
            while (headerRow.children.length > 1) {
                headerRow.removeChild(headerRow.lastChild);
            }

            // Build date headers
            dates.forEach(date => {
                const th = document.createElement('th');
                const formatted = formatDate(date);
                if (date.getDay() === 1) {
                    th.classList.add('week-separator');
                }
                th.innerHTML = `
                <div class="date-header">
                    <div class="date-number">${formatted.number}</div>
                    <div class="date-day">${formatted.day}</div>
                </div>
            `;
                headerRow.appendChild(th);
            });

            // Sort collaborators: current user first, then those with data, then alphabetically
            const finalCollaborateurs = [...collaborateurs].sort((a, b) => {
                const aIsCurrentUser = a.email.toLowerCase() === currentUser.email.toLowerCase();
                const bIsCurrentUser = b.email.toLowerCase() === currentUser.email.toLowerCase();

                if (aIsCurrentUser && !bIsCurrentUser) return -1;
                if (!aIsCurrentUser && bIsCurrentUser) return 1;

                if (!aIsCurrentUser && !bIsCurrentUser) {
                    const aHasData = dates.some(date => {
                        const dateKey = date.toISOString().split('T')[0];
                        const status = (presences[a.email.toLowerCase()] && presences[a.email.toLowerCase()][dateKey]) || 'undefined';
                        return status !== 'undefined';
                    });

                    const bHasData = dates.some(date => {
                        const dateKey = date.toISOString().split('T')[0];
                        const status = (presences[b.email.toLowerCase()] && presences[b.email.toLowerCase()][dateKey]) || 'undefined';
                        return status !== 'undefined';
                    });

                    if (aHasData && !bHasData) return -1;
                    if (!aHasData && bHasData) return 1;
                }
                return a.nom.localeCompare(b.nom);
            });

            // Build table rows
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';

            finalCollaborateurs.forEach(collab => {
                const row = document.createElement('tr');
                if (collab.email.toLowerCase() === currentUser.email.toLowerCase()) {
                    row.classList.add('current-user-row');
                }

                const nameCell = document.createElement('td');
                nameCell.innerHTML = `<div class="collab-name ${collab.email.toLowerCase() === currentUser.email.toLowerCase() ? 'current-user' : ''}">${collab.nom}${collab.email.toLowerCase() === currentUser.email.toLowerCase() ? ' (vous)' : ''}</div>`;
                row.appendChild(nameCell);

                dates.forEach(date => {
                    const cell = document.createElement('td');
                    const dateKey = date.toISOString().split('T')[0];
                    if (date.getDay() === 1) {
                        cell.classList.add('week-separator');
                    }
                    const status = (presences[collab.email.toLowerCase()] && presences[collab.email.toLowerCase()][dateKey]) || 'undefined';
                    const select = createSelect(collab.email, dateKey, status);
                    cell.appendChild(select);
                    row.appendChild(cell);
                });
                tableBody.appendChild(row);
            });
            updateStats();
        }

        // Create select dropdown for presence status
        function createSelect(collaborateurEmail, dateKey, status) {
            const select = document.createElement('select');
            select.className = `presence-select ${status}`;

            const options = [
                { value: 'undefined', text: '‚ùî ?' },
                { value: 'devoteam', text: 'üè¢ Devoteam' },
                { value: 'client', text: 'üëî Client' },
                { value: 'remote', text: 'üè† Remote' },
                { value: 'off', text: 'üî¥ OFF' }
            ];

            options.forEach(option => {
                const optionEl = document.createElement('option');
                optionEl.value = option.value;
                optionEl.textContent = option.text;
                if (option.value === status) {
                    optionEl.selected = true;
                }
                select.appendChild(optionEl);
            });

            const canEdit = currentUser && (currentUser.canEditAll || collaborateurEmail.toLowerCase() === currentUser.email.toLowerCase());

            if (!canEdit) {
                select.disabled = true;
            } else {
                select.addEventListener('change', (e) => {
                    const newStatus = e.target.value;
                    select.style.opacity = '0.6';
                    select.disabled = true;
                    google.script.run
                        .withSuccessHandler(() => handlePresenceUpdate(collaborateurEmail, dateKey, newStatus))
                        .withFailureHandler((error) => {
                            select.value = status;
                            select.style.opacity = '1';
                            select.disabled = false;
                            handleError(error);
                        })
                        .savePresenceForDate(collaborateurEmail, dateKey, newStatus);
                });
            }
            return select;
        }

        // Handle presence update success
        function handlePresenceUpdate(collaborateurEmail, dateKey, newStatus) {
            const cleanEmail = collaborateurEmail.toLowerCase();
            if (!presences[cleanEmail]) {
                presences[cleanEmail] = {};
            }
            presences[cleanEmail][dateKey] = newStatus;
            renderTable();
        }

        // Update statistics counters
        function updateStats() {
            const today = new Date().toISOString().split('T')[0];
            let totalDevoteam = 0;
            let totalClient = 0;
            let totalRemote = 0;
            let totalOff = 0;

            collaborateurs.forEach(collab => {
                const cleanEmail = collab.email.toLowerCase();
                const status = (presences[cleanEmail] && presences[cleanEmail][today]) || 'undefined';
                if (status === 'devoteam') totalDevoteam++;
                else if (status === 'client') totalClient++;
                else if (status === 'remote') totalRemote++;
                else if (status === 'off') totalOff++;
            });

            const placesDisponibles = 25;
            const placesRestantes = placesDisponibles - totalDevoteam;
            const occupancyRate = Math.round((totalDevoteam / placesDisponibles) * 100);

            document.querySelectorAll('#totalDevoteam').forEach(el => el.textContent = totalDevoteam);
            document.querySelectorAll('#totalClient').forEach(el => el.textContent = totalClient);
            document.querySelectorAll('#totalRemote').forEach(el => el.textContent = totalRemote);
            document.querySelectorAll('#totalOff').forEach(el => el.textContent = totalOff);
            document.querySelectorAll('#occupancyRate').forEach(el => el.textContent = occupancyRate + '%');
            document.querySelectorAll('#occupancyLabel').forEach(el =>
                el.textContent = `Occupation (${placesRestantes} places restantes)`
            );
        }

        // Generate stats HTML
        function createStatsHTML() {
            return `
                <div class="stats">
                  <div class="stat-item">
                      <div class="stat-number" id="totalDevoteam">0</div>
                      <div class="stat-label">Aujourd'hui √† Devoteam üè¢</div>
                  </div>
                  <div class="stat-item">
                      <div class="stat-number" id="totalClient">0</div>
                      <div class="stat-label">Chez un Client üëî</div>
                  </div>
                  <div class="stat-item">
                      <div class="stat-number" id="totalRemote">0</div>
                      <div class="stat-label">En Remote üè†</div>
                  </div>
                  <div class="stat-item">
                      <div class="stat-number" id="totalOff">0</div>
                      <div class="stat-label">OFF üî¥</div>
                  </div>
                  <div class="stat-item">
                      <div class="stat-number" id="occupancyRate">0%</div>
                      <div class="stat-label" id="occupancyLabel">Occupation Devoteam</div>
                  </div>
              </div>
            `;
        }

        // Refresh all data
        function refreshData() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('loading').textContent = 'üîÑ Actualisation en cours...';
                document.getElementById('mainContent').style.display = 'none';
                presences = {};
                loadData();
            } catch (error) {
                console.error('Erreur lors de l\'actualisation:', error);
                location.reload();
            }
        }

        // Show lunch popup with people at Devoteam today
        function showLunchPopup() {
            const today = new Date().toISOString().split('T')[0];
            const devoteamToday = [];

            collaborateurs.forEach(collab => {
                const cleanEmail = collab.email.toLowerCase();
                const status = (presences[cleanEmail] && presences[cleanEmail][today]) || 'undefined';
                if (status === 'devoteam') {
                    devoteamToday.push(collab.nom);
                }
            });

            let listContent = '';
            if (devoteamToday.length === 0) {
                listContent = '<p style="color: #999; font-style: italic;">Personne n\'est pr√©vu √† Devoteam aujourd\'hui üò¢</p>';
            } else {
                listContent = '<ul style="text-align: left; margin: 15px 0; padding-left: 20px;">';
                devoteamToday.forEach(nom => {
                    listContent += `<li style="margin: 8px 0; color: #333;">${nom}</li>`;
                });
                listContent += '</ul>';
                listContent += `<p style="color: #666; font-size: 0.9em; margin-top: 15px;">Total : ${devoteamToday.length} personne${devoteamToday.length > 1 ? 's' : ''}</p>`;
            }

            showPopup("üçΩÔ∏è D√©jeuner √† Devoteam", "Avec qui d√©jeuner aujourd'hui au bureau ü§† ?" + listContent);
        }

        // Generic popup display function
        function showPopup(title, content, showCloseButton = true) {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
                align-items: center; justify-content: center;
            `;

            const popup = document.createElement('div');
            popup.style.cssText = `
                background: white; border-radius: 12px; padding: 25px;
                max-width: 400px; box-shadow: 0 20px 40px rgba(0,0,0,0.2);
                text-align: center;
            `;

            let closeButtonHtml = '';
            if (showCloseButton) {
                closeButtonHtml = `
                    <button onclick="this.closest('[style*=fixed]').remove()" 
                            style="background: rgba(255,82,82,1); color: white; border: none; 
                                  padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 15px;">
                        Fermer
                    </button>`;
            }

            popup.innerHTML = `
                <h3 style="margin: 0 0 15px; color: #333;">${title}</h3>
                <div>${content}</div>
                ${closeButtonHtml}
            `;

            overlay.appendChild(popup);
            document.body.appendChild(overlay);

            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.remove();
                }
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>

</html>