<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meeting Transcriber - Squad Azure</title>
    <link rel="icon" type="image/png"
        href="https://creativetech-fr.devoteam.com/wp-content/uploads/2021/11/cropped-favicon_dvt_ct.png">
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <img src="https://creativetech-fr.devoteam.com/wp-content/uploads/2021/11/cropped-favicon_dvt_ct.png"
                    alt="Devoteam" class="header-logo">
                <div class="header-text">
                    <h1>Squad Azure â˜ï¸ - Meeting Transcriber ğŸ“</h1>
                    <p>Transformez vos rÃ©unions en comptes-rendus structurÃ©s</p>
                </div>
            </div>
        </div>

        <div class="content">

            <!-- Conseil d'enregistrement -->
            <p class="recording-tip">ğŸ’¡ Astuce : Enregistrez avec le dictaphone de votre smartphone ou l'app
                Enregistreur vocal de Windows</p>

            <!-- Zone d'upload AUDIO -->
            <div class="upload-zone" id="uploadZoneAudio">
                <div class="upload-icon">ğŸ™ï¸</div>
                <div class="upload-text">
                    <strong>Glissez un fichier audio</strong> ou cliquez pour sÃ©lectionner
                </div>
                <div class="supported-formats">
                    Formats supportÃ©s : .m4a (iPhone), .mp3, .wav, .ogg, .flac
                </div>
                <div class="file-info" id="fileInfoAudio"></div>
                <input type="file" id="fileInputAudio" accept=".wav,.mp3,.m4a,.ogg,.flac,.webm"
                    style="display: none;" />
            </div>

            <!-- Options -->
            <div class="options-section">
                <!-- Type de transcription -->
                <div class="form-field">
                    <label for="transcriptionType">ğŸ“‹ Provenance de l'audio :</label>
                    <select id="transcriptionType">
                        <option value="note">Note personnelle (mode dictaphone)</option>
                        <option value="telephone">Conversation tÃ©lÃ©phonique (1:1)</option>
                        <option value="confcall" selected>RÃ©union en conf-call ou visio</option>
                        <option value="salle">RÃ©union en salle (prÃ©sentiel)</option>
                        <option value="interview">Entretien Devoteam E2/E3 (formatage SmartRecruiter)</option>
                        <option value="conf">ConfÃ©rence (vous Ã©coutez seulement)</option>
                    </select>
                </div>

                <!-- Contexte optionnel -->
                <div class="form-field">
                    <label for="contextInfo">ğŸ’¡ Contexte (optionnel) :</label>
                    <input type="text" id="contextInfo"
                        placeholder="Ex: Point projet migration Azure avec client Toto" />
                </div>

                <!-- Email destinataire -->
                <div class="form-field">
                    <label for="emailTo">ğŸ“§ Votre adresse email :</label>
                    <input type="email" id="emailTo" placeholder="prenom.nom@devoteam.com" />
                    <small>Uniquement les adresses @devoteam.com</small>
                </div>

                <!-- Sujet de l'email -->
                <div class="form-field">
                    <label for="emailSubject">ğŸ“ Sujet de l'email :</label>
                    <input type="text" id="emailSubject" value="Compte-rendu de rÃ©union" />
                </div>
            </div>

            <!-- Bouton envoyer -->
            <button class="btn-submit" id="btnSubmit" disabled>
                ğŸš€ Recevoir le compte-rendu par email
            </button>

            <!-- Zone de confirmation -->
            <div class="confirmation-zone" id="confirmationZone">
                <div class="confirmation-icon">âœ…</div>
                <h2>Traitement lancÃ© !</h2>
                <p>Vous recevrez le compte-rendu par email dans <strong>15-20 minutes</strong> environ.</p>
                <p class="email-info">ğŸ“§ Destinataire : <span id="confirmEmail"></span></p>
                <button class="btn-new" id="btnNew">Nouveau traitement</button>
            </div>

            <!-- Erreur -->
            <div class="error-zone" id="errorZone"></div>
        </div>

        <div class="footer">
            Devoteam M Cloud - Squad Azure - Meeting Transcriber ğŸ¤–
            <br />
            Azure Speech + Claude API - Version 1.2 - Janvier 2025
            <br />
            Contact : <a href="mailto:thibault.gibard@devoteam.com">thibault.gibard@devoteam.com</a> ğŸ“§
        </div>
    </div>

    <script>
        // Ã‰lÃ©ments DOM
        const uploadZoneAudio = document.getElementById('uploadZoneAudio');
        const fileInputAudio = document.getElementById('fileInputAudio');
        const fileInfoAudio = document.getElementById('fileInfoAudio');
        const transcriptionType = document.getElementById('transcriptionType');
        const contextInfo = document.getElementById('contextInfo');
        const emailTo = document.getElementById('emailTo');
        const emailSubject = document.getElementById('emailSubject');
        const btnSubmit = document.getElementById('btnSubmit');
        const confirmationZone = document.getElementById('confirmationZone');
        const confirmEmail = document.getElementById('confirmEmail');
        const btnNew = document.getElementById('btnNew');
        const errorZone = document.getElementById('errorZone');

        let currentAudioFile = null;

        // Gestion de l'upload AUDIO
        uploadZoneAudio.addEventListener('click', () => fileInputAudio.click());

        uploadZoneAudio.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZoneAudio.classList.add('dragover');
        });

        uploadZoneAudio.addEventListener('dragleave', () => {
            uploadZoneAudio.classList.remove('dragover');
        });

        uploadZoneAudio.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZoneAudio.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) handleAudioFile(file);
        });

        fileInputAudio.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleAudioFile(file);
        });

        function handleAudioFile(file) {
            const validExtensions = ['.wav', '.mp3', '.m4a', '.ogg', '.flac', '.webm'];
            const ext = '.' + file.name.split('.').pop().toLowerCase();

            if (!validExtensions.includes(ext)) {
                showError('Format audio non supportÃ©.');
                return;
            }

            currentAudioFile = file;
            uploadZoneAudio.classList.add('has-file');

            const fileSizeMB = (file.size / (1024 * 1024)).toFixed(1);
            fileInfoAudio.textContent = `âœ“ ${file.name} (${fileSizeMB} Mo)`;

            checkCanSubmit();
        }

        // Validation email @devoteam.com
        emailTo.addEventListener('input', checkCanSubmit);

        function checkCanSubmit() {
            const hasFile = currentAudioFile !== null;
            const email = emailTo.value.trim().toLowerCase();
            const isValidEmail = email.endsWith('@devoteam.com') && email.length > '@devoteam.com'.length;

            btnSubmit.disabled = !(hasFile && isValidEmail);
        }

        function showError(message) {
            errorZone.textContent = 'âš ï¸ ' + message;
            errorZone.classList.add('visible');
            setTimeout(() => errorZone.classList.remove('visible'), 5000);
        }

        // Soumission du formulaire
        btnSubmit.addEventListener('click', async () => {
            if (!currentAudioFile) return;

            const email = emailTo.value.trim();
            if (!email.toLowerCase().endsWith('@devoteam.com')) {
                showError('Adresse email invalide');
                return;
            }

            btnSubmit.disabled = true;
            btnSubmit.textContent = 'â³ Envoi en cours...';
            errorZone.classList.remove('visible');

            try {
                // CrÃ©er FormData pour l'upload
                const formData = new FormData();
                formData.append('audio', currentAudioFile);
                formData.append('type', transcriptionType.value);
                formData.append('context', contextInfo.value.trim());
                formData.append('email', email);
                formData.append('subject', emailSubject.value.trim());

                const response = await fetch('/api/process', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Erreur lors de l\'envoi');
                }

                // Afficher confirmation
                confirmEmail.textContent = email;
                document.querySelector('.content').classList.add('submitted');
                confirmationZone.classList.add('visible');

            } catch (error) {
                showError(error.message);
                btnSubmit.disabled = false;
                btnSubmit.textContent = 'ğŸš€ Recevoir le compte-rendu par email';
            }
        });

        // Nouveau traitement
        btnNew.addEventListener('click', () => {
            currentAudioFile = null;
            fileInputAudio.value = '';
            fileInfoAudio.textContent = '';
            uploadZoneAudio.classList.remove('has-file');
            contextInfo.value = '';
            emailTo.value = '';
            emailSubject.value = 'Compte-rendu de rÃ©union';
            btnSubmit.disabled = true;
            btnSubmit.textContent = 'ğŸš€ Recevoir le compte-rendu par email';
            confirmationZone.classList.remove('visible');
            document.querySelector('.content').classList.remove('submitted');
        });

        checkCanSubmit();
    </script>
</body>

</html>